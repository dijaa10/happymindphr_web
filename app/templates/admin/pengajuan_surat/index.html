{% extends "admin/layouts/main.html" %} 
{% block title %} Data Pengajuan Surat {% endblock %}
{% block content %}
<header class="mb-3">
  <a href="#" class="burger-btn d-block d-xl-none">
    <i class="bi bi-justify fs-3"></i>
  </a>
</header>

<div class="page-heading">
  <div class="page-title">
    <div class="row">
      <div class="col-12 col-md-6 order-md-1 order-last">
        <h3>Data Pengajuan Surat</h3>
        <p class="text-subtitle text-muted">
          Dibawah ini data mahasiswa yang mengajukan surat kesehatan dan sudah melakukan test awal
        </p>
      </div>
      <div class="col-12 col-md-6 order-md-2 order-first">
        <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">
              Data Pengajuan Surat
            </li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <section class="section">
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table" id="data">
            <thead>
              <tr>
                <th>No</th>
                <th>id</th>
                <th>Nama</th>
                <th>NIM</th>
                <th>Waktu Mulai</th>
                <th>Waktu Berakhir</th>
                <th>Aksi</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="modal fade" id="modalDataKesehatan" tabindex="-1" aria-labelledby="modalDataKesehatanLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDataKesehatanLabel">Input Data Kesehatan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formDataKesehatan">
          <input type="hidden" id="mahasiswa_id" name="mahasiswa_id">
          <input type="hidden" id="print_url" name="print_url">
          
          <div class="mb-3">
            <label for="nama_mahasiswa" class="form-label">Nama Mahasiswa</label>
            <input type="text" class="form-control" id="nama_mahasiswa" readonly>
          </div>
          
          <div class="mb-3">
            <label for="tinggi_badan" class="form-label">Tinggi Badan (cm) <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="tinggi_badan" name="tinggi_badan" required>
          </div>
          
          <div class="mb-3">
            <label for="berat_badan" class="form-label">Berat Badan (kg) <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="berat_badan" name="berat_badan" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Tensi (mmHg) <span class="text-danger">*</span></label>
            <div class="row">
              <div class="col-6">
                <label for="tensi_sistolik" class="form-label small">Sistolik (Atas)</label>
                <input type="number" class="form-control" id="tensi_sistolik" name="tensi_sistolik" min="50" max="250" required>
              </div>
              <div class="col-6">
                <label for="tensi_diastolik" class="form-label small">Diastolik (Bawah)</label>
                <input type="number" class="form-control" id="tensi_diastolik" name="tensi_diastolik" min="30" max="150" required>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btnSimpanDanCetak">Simpan dan Cetak</button>
      </div>
    </div>
  </div>
</div>

{% endblock %} 

{% block script %}
<script>
  $(document).ready(function () {
    var table = $("#data").DataTable({
      columnDefs: [
        {
          searchable: true,
          orderable: true,
          targets: 2,
        },
      ],
      processing: true,
      ajax: {
        url: "{{ url_for('pengajuan_surat_json') }}",
        type: "GET",
        beforeSend: function (xhr) {
          xhr.setRequestHeader("Content-Type", "application/json");
        },
      },
      columns: [
        {
          data: "id_row",
          name: "id_row",
          render: function (data, type, row, meta) {
            return meta.row + meta.settings._iDisplayStart + 1;
          },
        },
        {
          data: "mahasiswa_id",
          name: "mahasiswa_id",
          visible: false
        },
        {
          data: "mahasiswa_nama",
          name: "mahasiswa_nama",
        },
        {
          data: "mahasiswa_nim",
          name: "mahasiswa_nim",
        },
        {
          data: "dass21_test_start_time",
          name: "dass21_test_start_time",
          sortable: false,
        },
        {
          data: "dass21_test_end_time",
          name: "dass21_test_end_time",
          sortable: false,
        },
        {
          data: null,
          name: "aksi",
          sortable: false,
          render: (data, type, row, meta) => {
            var edit_url = "{{ url_for('pengajuan_surat_edit', id_mahasiswa=':var', waktu_mulai=':waktu_mulai') }}"
            var print_url = "{{ url_for('pengajuan_surat_print', id_mahasiswa=':var', waktu_mulai=':waktu_mulai') }}";
            
            return `<div style="min-height:36px; display: flex; gap: 5px; flex-wrap: wrap;">
              <a href="${edit_url.replace(':var', data.mahasiswa_id).replace(':waktu_mulai', data.dass21_test_start_time)}" 
                 class="btn icon btn-outline-success" 
                 title="Detail">
                <i class="bi bi-info-circle"></i>
              </a>
              <button 
                 class="btn icon btn-outline-primary btn-print-modal" 
                 data-mahasiswa-id="${data.mahasiswa_id}"
                 data-mahasiswa-nama="${data.mahasiswa_nama}"
                 data-waktu-mulai="${data.dass21_test_start_time}"
                 data-print-url="${print_url.replace(':var', data.mahasiswa_id).replace(':waktu_mulai', data.dass21_test_start_time)}"
                 title="Print Surat Kesehatan">
                <i class="bi bi-printer"></i>
              </button>
            </div>`;
          }
        }
      ],
    });

    $(document).on('click', '.btn-print-modal', function() {
      var mahasiswaId = $(this).data('mahasiswa-id');
      var mahasiswaNama = $(this).data('mahasiswa-nama');
      var waktuMulai = $(this).data('waktu-mulai');
      var printUrl = $(this).data('print-url');
      
      $('#mahasiswa_id').val(mahasiswaId);
      $('#nama_mahasiswa').val(mahasiswaNama);
      $('#print_url').val(printUrl);
      $('#tinggi_badan').val('');
      $('#berat_badan').val('');
      $('#tensi_sistolik').val('');
      $('#tensi_diastolik').val('');
      $('#modalDataKesehatan').modal('show');
    });

    $('#btnSimpanDanCetak').click(function() {
      var form = $('#formDataKesehatan');
      
      if (!form[0].checkValidity()) {
        form[0].reportValidity();
        return;
      }
      
      var data = {
        mahasiswa_id: $('#mahasiswa_id').val(),
        tinggi_badan: $('#tinggi_badan').val(),
        berat_badan: $('#berat_badan').val(),
        tensi_sistolik: $('#tensi_sistolik').val(),
        tensi_diastolik: $('#tensi_diastolik').val()
      };
      
      $(this).prop('disabled', true).text('Menyimpan');
      
      $.ajax({
        url: "{{ url_for('save_data_kesehatan_route') }}",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function(response) {
          if (response.success) {
            $('#modalDataKesehatan').modal('hide');
            var printUrl = $('#print_url').val();
            window.open(printUrl, '_blank');           
            $('#btnSimpanDanCetak').prop('disabled', false).text('Simpan dan Cetak');
          } else {
            alert('Gagal menyimpan data: ' + response.message);
            $('#btnSimpanDanCetak').prop('disabled', false).text('Simpan dan Cetak');
          }
        },
        error: function(xhr, status, error) {
          alert('Terjadi kesalahan: ' + error);
          $('#btnSimpanDanCetak').prop('disabled', false).text('Simpan dan Cetak');
        }
      });
    });
  });
</script>
{% endblock %}